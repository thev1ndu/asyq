{"version":3,"sources":["../src/autoenv.ts","../src/scan.ts"],"sourcesContent":["#!/usr/bin/env node\nimport { Command } from \"commander\";\nimport fs from \"node:fs\";\nimport path from \"node:path\";\nimport pc from \"picocolors\";\nimport ora from \"ora\";\nimport boxen from \"boxen\";\nimport logUpdate from \"log-update\";\nimport Table from \"cli-table3\";\nimport { scanProjectForEnvKeys } from \"./scan.js\";\n\ntype Step = {\n  title: string;\n  status: \"pending\" | \"running\" | \"done\" | \"fail\";\n  detail?: string;\n};\n\nfunction renderHeader() {\n  const title = pc.bold(\"autoEnv\");\n  const subtitle = pc.dim(\n    \"Generate .env.example by scanning your project for env usage\"\n  );\n  const body = `${title}\\n${subtitle}`;\n\n  // boxen makes it feel like Next.js / Sentry installers\n  // No emojis; clean layout\n  console.log(\n    boxen(body, {\n      padding: 1,\n      borderStyle: \"round\",\n      borderColor: \"cyan\",\n    })\n  );\n  console.log(\"\");\n}\n\nfunction icon(status: Step[\"status\"]) {\n  if (status === \"done\") return pc.green(\"✓\");\n  if (status === \"fail\") return pc.red(\"✗\");\n  if (status === \"running\") return pc.cyan(\"•\");\n  return pc.dim(\"•\");\n}\n\nfunction renderSteps(steps: Step[]) {\n  const lines = steps.map((s) => {\n    const left = `${icon(s.status)} ${s.title}`;\n    const right = s.detail ? pc.dim(s.detail) : \"\";\n    return right ? `${left} ${right}` : left;\n  });\n  logUpdate(lines.join(\"\\n\"));\n}\n\nfunction finishSteps() {\n  logUpdate.done();\n}\n\nfunction fail(message: string, hint?: string) {\n  console.error(pc.red(message));\n  if (hint) console.error(pc.dim(hint));\n  process.exit(1);\n}\n\nconst program = new Command();\n\nprogram\n  .name(\"autoEnv\")\n  .description(\"Generate .env.example by scanning your project for env usage\")\n  .version(\"2.0.1\");\n\nprogram\n  .command(\"init\")\n  .description(\"Scan project and generate .env.example with KEY= lines\")\n  .option(\"--root <dir>\", \"Project root to scan\", \".\")\n  .option(\"--out <file>\", \"Output file\", \".env.example\")\n  .option(\"--force\", \"Overwrite output if it exists\")\n  .option(\n    \"--include-lowercase\",\n    \"Include lowercase/mixed-case keys (not recommended)\"\n  )\n  .option(\"--debug\", \"Print scan diagnostics\")\n  .action((opts) => {\n    renderHeader();\n\n    const root = path.resolve(process.cwd(), opts.root);\n    const outFile = path.resolve(process.cwd(), opts.out);\n\n    if (fs.existsSync(outFile) && !opts.force) {\n      fail(`Output already exists: ${opts.out}`, \"Use --force to overwrite.\");\n    }\n\n    const steps: Step[] = [\n      { title: \"Preparing\", status: \"running\", detail: `root: ${opts.root}` },\n      { title: \"Scanning project files\", status: \"pending\" },\n      {\n        title: \"Generating .env.example\",\n        status: \"pending\",\n        detail: `out: ${opts.out}`,\n      },\n      { title: \"Summary\", status: \"pending\" },\n    ];\n\n    renderSteps(steps);\n\n    // Step 1: prepare\n    steps[0].status = \"done\";\n    steps[0].detail = `root: ${opts.root}`;\n    steps[1].status = \"running\";\n    renderSteps(steps);\n\n    // Spinner for scan (feels premium)\n    const spinner = ora({\n      text: \"Scanning for environment keys\",\n      spinner: \"dots\",\n    }).start();\n\n    const res = scanProjectForEnvKeys({\n      rootDir: root,\n      includeLowercase: !!opts.includeLowercase,\n    });\n\n    spinner.stop();\n\n    steps[1].status = \"done\";\n    steps[1].detail = `${res.filesScanned} files scanned`;\n    steps[2].status = \"running\";\n    renderSteps(steps);\n\n    if (opts.debug) {\n      console.log(pc.dim(`\\nDiagnostics`));\n      console.log(pc.dim(`  root: ${opts.root}`));\n      console.log(pc.dim(`  files scanned: ${res.filesScanned}`));\n      console.log(pc.dim(`  keys found: ${res.keys.size}\\n`));\n    }\n\n    if (res.keys.size === 0) {\n      steps[2].status = \"fail\";\n      renderSteps(steps);\n      finishSteps();\n      fail(\n        \"No environment variables found.\",\n        \"Ensure your code uses process.env.KEY or configs use ${KEY}. If this is a monorepo, try --root apps or --root packages.\"\n      );\n    }\n\n    const sorted = [...res.keys].sort((a, b) => a.localeCompare(b));\n    const content = sorted.map((k) => `${k}=`).join(\"\\n\") + \"\\n\";\n\n    fs.writeFileSync(outFile, content, \"utf8\");\n\n    steps[2].status = \"done\";\n    steps[2].detail = `wrote ${opts.out}`;\n    steps[3].status = \"running\";\n    renderSteps(steps);\n\n    // Summary table (Sentry/Next-like polish)\n    const t = new Table({\n      style: { head: [], border: [] },\n      colWidths: [20, 60],\n      wordWrap: true,\n    });\n\n    t.push(\n      [pc.dim(\"Output\"), pc.cyan(opts.out)],\n      [pc.dim(\"Keys\"), pc.cyan(String(sorted.length))],\n      [pc.dim(\"Scan root\"), pc.cyan(opts.root)]\n    );\n\n    steps[3].status = \"done\";\n    renderSteps(steps);\n    finishSteps();\n\n    console.log(\"\");\n    console.log(pc.bold(\"Done\"));\n    console.log(t.toString());\n    console.log(pc.dim(\"Next steps:\"));\n    console.log(pc.dim(`  1) Fill values in ${opts.out}`));\n    console.log(pc.dim(\"  2) Copy to .env (do not commit secrets)\"));\n    console.log(\"\");\n  });\n\nprogram.parse(process.argv);\n","import fs from \"node:fs\";\nimport path from \"node:path\";\n\nexport type ScanOptions = {\n  rootDir: string;\n  includeLowercase?: boolean; // default false (enterprise-safe)\n};\n\nexport type ScanResult = {\n  keys: Set<string>;\n  filesScanned: number;\n};\n\nconst IGNORE_DIRS = new Set([\n  \"node_modules\",\n  \".git\",\n  \"dist\",\n  \"build\",\n  \".next\",\n  \"out\",\n  \"coverage\",\n  \".turbo\",\n  \".cache\",\n]);\n\n/**\n * Default env key style:\n *   DB_URL, REDIS_URL, NEXT_PUBLIC_API_URL, SENTRY_DSN, AWS_REGION\n *\n * You can enable lowercase keys via CLI flag if your project uses them.\n */\nconst ENV_KEY_RE_STRICT = /^[A-Z][A-Z0-9_]*$/;\nconst ENV_KEY_RE_LOOSE = /^[A-Za-z_][A-Za-z0-9_]*$/;\n\nexport function scanProjectForEnvKeys(opts: ScanOptions): ScanResult {\n  const root = opts.rootDir;\n  const keyOk = (k: string) =>\n    (opts.includeLowercase ? ENV_KEY_RE_LOOSE : ENV_KEY_RE_STRICT).test(k);\n\n  // Keep it lightweight: scan common source/config formats (NOT markdown).\n  // We do NOT parse KEY= lines from these; only structured env patterns.\n  const exts = new Set([\n    \".ts\",\n    \".tsx\",\n    \".js\",\n    \".jsx\",\n    \".mjs\",\n    \".cjs\",\n    \".json\",\n    \".yml\",\n    \".yaml\",\n    \".toml\",\n  ]);\n\n  const keys = new Set<string>();\n  let filesScanned = 0;\n\n  walk(root);\n  return { keys, filesScanned };\n\n  function walk(dir: string) {\n    let entries: fs.Dirent[];\n    try {\n      entries = fs.readdirSync(dir, { withFileTypes: true });\n    } catch {\n      return;\n    }\n\n    for (const entry of entries) {\n      const full = path.join(dir, entry.name);\n\n      if (entry.isDirectory()) {\n        if (!IGNORE_DIRS.has(entry.name)) walk(full);\n        continue;\n      }\n\n      const isEnvFile = entry.name === \".env\" || entry.name.startsWith(\".env.\");\n      const ext = path.extname(entry.name);\n\n      if (!isEnvFile && !exts.has(ext)) continue;\n\n      const content = safeRead(full);\n      if (!content) continue;\n\n      filesScanned++;\n\n      if (isEnvFile) {\n        extractFromEnvFile(content, keys, keyOk);\n      } else {\n        extractFromCodeAndConfigs(content, keys, keyOk);\n      }\n    }\n  }\n}\n\n/**\n * Extract from .env / .env.* files ONLY:\n * Accept lines like:\n *   KEY=value\n *   export KEY=value\n * Ignore:\n *   comments, blank lines\n */\nfunction extractFromEnvFile(\n  text: string,\n  keys: Set<string>,\n  keyOk: (k: string) => boolean\n) {\n  for (const m of text.matchAll(\n    /^\\s*(?:export\\s+)?([A-Za-z_][A-Za-z0-9_]*)\\s*=/gm\n  )) {\n    const k = m[1];\n    if (keyOk(k)) keys.add(k);\n  }\n}\n\n/**\n * Extract env keys from code/config formats:\n * - process.env.KEY\n * - process.env[\"KEY\"]\n * - import.meta.env.KEY\n * - Deno.env.get(\"KEY\")\n * - ${KEY}\n *\n * NOTE: We do NOT extract generic KEY= patterns here (avoids JSX/HTML noise).\n */\nfunction extractFromCodeAndConfigs(\n  text: string,\n  keys: Set<string>,\n  keyOk: (k: string) => boolean\n) {\n  // process.env.KEY / process.env?.KEY\n  for (const m of text.matchAll(\n    /\\bprocess(?:\\?\\.)?\\.env(?:\\?\\.)?\\.([A-Za-z_][A-Za-z0-9_]*)\\b/g\n  )) {\n    const k = m[1];\n    if (keyOk(k)) keys.add(k);\n  }\n\n  // process.env[\"KEY\"] / ['KEY']\n  for (const m of text.matchAll(\n    /\\bprocess(?:\\?\\.)?\\.env\\[\\s*[\"']([A-Za-z_][A-Za-z0-9_]*)[\"']\\s*\\]/g\n  )) {\n    const k = m[1];\n    if (keyOk(k)) keys.add(k);\n  }\n\n  // import.meta.env.KEY\n  for (const m of text.matchAll(\n    /\\bimport\\.meta\\.env\\.([A-Za-z_][A-Za-z0-9_]*)\\b/g\n  )) {\n    const k = m[1];\n    if (keyOk(k)) keys.add(k);\n  }\n\n  // Deno.env.get(\"KEY\")\n  for (const m of text.matchAll(\n    /\\bDeno\\.env\\.get\\(\\s*[\"']([A-Za-z_][A-Za-z0-9_]*)[\"']\\s*\\)/g\n  )) {\n    const k = m[1];\n    if (keyOk(k)) keys.add(k);\n  }\n\n  // ${KEY} (docker-compose, yaml, CI)\n  for (const m of text.matchAll(/\\$\\{([A-Za-z_][A-Za-z0-9_]*)\\}/g)) {\n    const k = m[1];\n    if (keyOk(k)) keys.add(k);\n  }\n}\n\nfunction safeRead(filePath: string): string | null {\n  try {\n    return fs.readFileSync(filePath, \"utf8\");\n  } catch {\n    return null;\n  }\n}\n"],"mappings":"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","names":["fs","path","path","fs"]}